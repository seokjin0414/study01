<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "mybatis-3-mapper.dtd">

<mapper namespace="com.metavegas.admin.dao.AirdropDao">

    <select id="tnEventAirdropList" parameterType="TnEventAirdrop" resultType="TnEventAirdrop">
        SELECT
        a.airdrop_idx
        , a.crncy_cd
        , a.crncy_type
        , a.volume
        , a.send_addr
        , a.receive_addr
        , a.tx_id
        , d.ext_tx_id
        , b.member_no AS usrIdx
        , c.usr_id
        , c.ref_cd
        , a.comment
        , a.status
        , a.reg_dtm
        , a.mod_dtm
        , d.state AS wdState
        , e.member_no AS sendUsrIdx
        FROM TN_EVENT_AIRDROP a
        LEFT JOIN wallet_address b ON b.addr = a.receive_addr AND b.crncy_cd = a.crncy_cd AND b.crncy_type = a.crncy_type
        LEFT JOIN TN_USER c ON c.usr_idx = b.member_no
        LEFT JOIN wallet_withdraw d ON d.loc_send_addr = a.tx_id
        LEFT JOIN wallet_address e ON e.addr = a.send_addr AND e.crncy_cd = a.crncy_cd AND e.crncy_type = a.crncy_type
        WHERE 1=1

        <if test="coinVal != null and coinVal != '' ">
            AND a.crncyCd = #{coinVal}
        </if>

        <if test="statusVal != null and statusVal != '' ">
            AND a.status = #{statusVal}
        </if>

        <if test="searchField != null and searchField != '' ">
            <if test="searchVal != null and searchVal != '' ">
                <if test="searchField == 'usrIdx'">
                    AND c.usr_idx = #{searchVal}
                </if>
                <if test="searchField == 'refCd'">
                    AND c.ref_cd = #{searchVal}
                </if>
                <if test="searchField == 'usrId'">
                    AND c.usr_id LIKE CONCAT('%', #{searchVal}, '%')
                </if>
                <if test="searchField == 'usrNick'">
                    AND c.usr_nick LIKE CONCAT('%', #{searchVal}, '%')
                </if>
                <if test="searchField == 'sendAddr'">
                    AND a.send_addr LIKE CONCAT('%', #{searchVal}, '%')
                </if>
                <if test="searchField == 'receiveAddr'">
                    AND a.receive_addr LIKE CONCAT('%', #{searchVal}, '%')
                </if>
            </if>
        </if>
        GROUP BY a.tx_id
        ORDER BY a.airdrop_idx DESC
    </select>

    <select id="tnEventAirdropListCnt" parameterType="TnEventAirdrop" resultType="int">
        SELECT
        COUNT(*)
        FROM TN_EVENT_AIRDROP a
        LEFT JOIN wallet_address b ON b.addr = a.receive_addr AND b.crncy_cd = a.crncy_cd AND b.crncy_type = a.crncy_type
        LEFT JOIN TN_USER c ON c.usr_idx = b.member_no
        LEFT JOIN wallet_withdraw d ON d.loc_send_addr = a.tx_id
        WHERE 1=1

        <if test="coinVal != null and coinVal != '' ">
            AND a.crncyCd = #{coinVal}
        </if>

        <if test="statusVal != null and statusVal != '' ">
            AND a.status = #{statusVal}
        </if>

        <if test="searchField != null and searchField != '' ">
            <if test="searchVal != null and searchVal != '' ">
                <if test="searchField == 'usrIdx'">
                    AND c.usr_idx = #{searchVal}
                </if>
                <if test="searchField == 'refCd'">
                    AND c.ref_cd = #{searchVal}
                </if>
                <if test="searchField == 'usrId'">
                    AND c.usr_id LIKE CONCAT('%', #{searchVal}, '%')
                </if>
                <if test="searchField == 'usrNick'">
                    AND c.usr_nick LIKE CONCAT('%', #{searchVal}, '%')
                </if>
                <if test="searchField == 'sendAddr'">
                    AND a.send_addr LIKE CONCAT('%', #{searchVal}, '%')
                </if>
                <if test="searchField == 'receiveAddr'">
                    AND a.receive_addr LIKE CONCAT('%', #{searchVal}, '%')
                </if>
            </if>
        </if>
    </select>

    <insert id="insertTnEventAirdrop" parameterType="TnEventAirdrop">
        INSERT INTO TN_EVENT_AIRDROP
        (
        crncy_cd
        , crncy_type
        , volume
        , send_addr
        , receive_addr
        , tx_id
        , comment
        )
        VALUES
        (
        #{crncyCd}
        , #{crncyType}
        , #{volume}
        , #{sendAddr}
        , #{receiveAddr}
        , #{txId}
        , #{comment}
        )
    </insert>

    <update id="updateTnEventAirdrop" parameterType="TnEventAirdrop">
        UPDATE TN_EVENT_AIRDROP
        SET
        tx_id = #{txId}
        , status = #{status}
        , mod_dtm = NOW()
        WHERE 1=1
        AND airdrop_idx = #{airdropIdx}
    </update>


</mapper>